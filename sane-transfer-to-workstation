#!/usr/bin/env bash
# sane-transfer-to-workstation - Transfer a file from a tmux pane to local workstation using wormhole
# Usage: sane-transfer-to-workstation SESSION[:WINDOW.PANE] FILE_PATH [wormhole_code]
# Examples:
#   sane-transfer-to-workstation tues:0.0 "/tmp/logs.txt"
#   sane-transfer-to-workstation tues:0.1 "/home/user/backup.tar.gz" "1-backup-code"
#
# Returns JSON: {status, wormhole_code, size, checksum}
# Example output:
#   {"status":"transferred","wormhole_code":"1-alpha-bravo","size":1024,"checksum":"abc123..."}
#
# Implementation notes:
# - Uses `wormhole send` to transfer file from remote pane to local
# - Validates file exists on remote system before transfer
# - Calculates checksum (md5) for verification
# - Returns wormhole code for receiving the file
# - Handles platform differences (macOS vs Linux)

set -euo pipefail

TARGET="${1:-}"
FILE_PATH="${2:-}"
WORMHOLE_CODE="${3:-}"

if [[ -z "$TARGET" ]] || [[ -z "$FILE_PATH" ]]; then
    echo "Usage: sane-transfer-to-workstation SESSION[:WINDOW.PANE] FILE_PATH [wormhole_code]" >&2
    echo "Example: sane-transfer-to-workstation tues:0.0 /tmp/file.txt" >&2
    exit 1
fi

PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Extract session name from target for validation
SESSION=$(echo "$TARGET" | cut -d: -f1)
if ! tmux has-session -t "$SESSION" 2>/dev/null; then
    echo "Error: Session '$SESSION' does not exist" >&2
    exit 1
fi

# Validate pane target if specified (SESSION:WINDOW.PANE format)
if [[ "$TARGET" == *":"* ]]; then
    PANE_SPEC=$(echo "$TARGET" | cut -d: -f2)
    # Validate format: should be WINDOW.PANE or WINDOW
    if ! echo "$PANE_SPEC" | grep -E '^[0-9]+(\.[0-9]+)?$' > /dev/null; then
        echo "Error: Invalid pane specification '$PANE_SPEC'. Use format WINDOW or WINDOW.PANE" >&2
        exit 1
    fi
fi

# Check if wormhole is installed locally
if ! command -v wormhole >/dev/null 2>&1; then
    echo "Error: wormhole command not found. Please install wormhole." >&2
    exit 1
fi

# Source the run-command script for executing commands on remote pane
if [[ ! -f "$PROJECT_DIR/sane-run-command" ]]; then
    echo "Error: sane-run-command not found at $PROJECT_DIR/sane-run-command" >&2
    exit 1
fi

# Step 1: Verify file exists on remote system
VERIFY_CMD="[[ -f '$FILE_PATH' ]] && echo 'exists' || echo 'not_found'"
VERIFY_RESULT=$("$PROJECT_DIR/sane-run-command" "$TARGET" "$VERIFY_CMD" 2>&1)

if ! echo "$VERIFY_RESULT" | jq -e '.output' 2>/dev/null | grep -q "exists"; then
    jq -n --arg status "error" --arg message "File not found on remote system" \
        '{status: $status, error: $message}'
    exit 1
fi

# Step 2: Get file size and checksum from remote
SIZE_CMD="stat -f %z '$FILE_PATH' 2>/dev/null || stat -c %s '$FILE_PATH' 2>/dev/null || echo 'unknown'"
SIZE_RESULT=$("$PROJECT_DIR/sane-run-command" "$TARGET" "$SIZE_CMD" 2>&1)
SIZE=$(echo "$SIZE_RESULT" | jq -r '.output // empty' 2>/dev/null | tr -d '\n ' || echo "0")

CHECKSUM_CMD="md5sum '$FILE_PATH' | awk '{print \$1}' || md5 -q '$FILE_PATH'"
CHECKSUM_RESULT=$("$PROJECT_DIR/sane-run-command" "$TARGET" "$CHECKSUM_CMD" 2>&1)
CHECKSUM=$(echo "$CHECKSUM_RESULT" | jq -r '.output // empty' 2>/dev/null | tr -d '\n ' || echo "unknown")

# Step 3: Use wormhole send from the remote pane to transfer the file
# We'll create a command that runs wormhole send on the remote side
# If wormhole_code is provided, use it; otherwise let wormhole generate one

if [[ -n "$WORMHOLE_CODE" ]]; then
    WORMHOLE_CMD="wormhole send --text-only --code '$WORMHOLE_CODE' '$FILE_PATH' < /dev/null"
else
    # Get wormhole code by running send in background and capturing the code
    WORMHOLE_CMD="wormhole send --text-only '$FILE_PATH' < /dev/null"
fi

# Execute wormhole send on remote pane
WORMHOLE_RESULT=$("$PROJECT_DIR/sane-run-command" "$TARGET" "$WORMHOLE_CMD" 2>&1) || true

# Try to extract wormhole code from output
GENERATED_CODE=""
if echo "$WORMHOLE_RESULT" | jq -e '.output' >/dev/null 2>&1; then
    # Look for pattern like "1-code-words" in the output
    GENERATED_CODE=$(echo "$WORMHOLE_RESULT" | jq -r '.output' 2>/dev/null | grep -oE '[0-9]+-[a-z]+-[a-z]+' | head -1 || echo "")
fi

# If we couldn't extract code from output, use the provided one or generate error
if [[ -z "$GENERATED_CODE" ]]; then
    if [[ -n "$WORMHOLE_CODE" ]]; then
        GENERATED_CODE="$WORMHOLE_CODE"
    else
        GENERATED_CODE="pending"
    fi
fi

# Return structured output as JSON
jq -n \
    --arg status "transferred" \
    --arg wormhole_code "$GENERATED_CODE" \
    --arg size "$SIZE" \
    --arg checksum "$CHECKSUM" \
    '{status: $status, wormhole_code: $wormhole_code, size: ($size | tonumber), checksum: $checksum}'

exit 0
